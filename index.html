<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Guess the osu! Rank</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    video { max-width: 100%; height: auto; border: 1px solid #ccc; margin: 1rem 0; }
    #guess-container { margin-top: 1rem; }
    #guess-container input { font-size: 1rem; padding: 0.25rem; width: 6rem; }
    #guess-container button { font-size: 1rem; margin-left:0.5rem; }
    #hints { margin-top: 1rem; text-align: left; display: inline-block; }
    #hints li { margin-bottom: 0.25rem; }
    #guess-result { margin-top: 0.5rem; font-weight: bold; }
    #reload { margin-top: 1rem; padding: 0.5rem 1rem; }
  </style>
</head>
<body>
  <h1>🎲 Guess the osu! Global Rank!</h1>
  <div id="info">Loading… 🔄</div>
  <video id="replay" controls></video>
  <div id="link"></div>

  <div id="guess-container" style="display:none;">
    <input type="number" id="guess-input" placeholder="Your guess" />
    <button id="guess-btn">Submit</button>
    <div id="guess-result"></div>
    <ul id="hints"></ul>
  </div>

  <button id="reload" style="display:none;">Next Replay</button>

  <script>
    // ── CONFIG ─────────────────────────────────────────────────────────
    const OSU_API_KEY = '1afe2d67d4fea6bdf58c5aeff3fd83e8c28be9d1';  
    const PROXY       = 'https://ordr-proxy.vnblemonade.workers.dev/?url=';  
    const PAGE_SIZE   = 50;
    const MAX_PAGES   = 10;
    const MAX_TRIES   = 10;

    // ── STATE ──────────────────────────────────────────────────────────
    let actualRank, countryRank, playTimeHrs, topPlayPP;
    let guessAttempts;

    // ── HELPERS ────────────────────────────────────────────────────────
    async function fetchJson(url){
      const r = await fetch(PROXY + encodeURIComponent(url));
      if(!r.ok) throw new Error('Proxy error '+r.status);
      return JSON.parse(await r.text());
    }
    async function getDirectLink(id){
      try {
        const r = await fetch(PROXY + encodeURIComponent(
          `https://apis.issou.best/dynlink/ordr/gen?id=${id}`
        ));
        if(!r.ok) return null;
        return JSON.parse(await r.text()).url || null;
      } catch { return null; }
    }
    function toleranceFor(rank){
      const len = String(rank).length;
      if(len===1) return 0;
      if(len===2) return 10;
      if(len===3) return 100;
      if(len===4) return 1000;
      if(len===5) return 10000;
      if(len===6) return 100000;
      return 500000;
    }

    // ── LOAD A NEW REPLAY ──────────────────────────────────────────────
    async function loadRandom(){
      // reset
      guessAttempts = 0;
      document.getElementById('info').textContent = 'Loading… 🔄';
      document.getElementById('replay').src = '';
      document.getElementById('link').innerHTML = '';
      document.getElementById('guess-container').style.display = 'none';
      document.getElementById('reload').style.display = 'none';
      document.getElementById('guess-input').value = '';
      document.getElementById('guess-result').textContent = '';
      document.getElementById('hints').innerHTML = '';

      try {
        let meta, url;
        for(let i=0;i<MAX_TRIES;i++){
          const page = Math.floor(Math.random()*MAX_PAGES)+1;
          const data = await fetchJson(
            `https://apis.issou.best/ordr/renders?pageSize=${PAGE_SIZE}`
            +`&page=${page}&nobots`
          );
          const done = data.renders.filter(r=>r.errorCode===0&&r.progress==='Done.');
          if(!done.length) continue;
          const pick = done[Math.floor(Math.random()*done.length)];
          const link = await getDirectLink(pick.renderID);
          if(link){ meta=pick; url=link; break; }
        }
        if(!meta) throw 'No replay';

        // show video
        document.getElementById('info').textContent =
          `${meta.username} – ${meta.title}`;
        document.getElementById('link').innerHTML =
          `<a href="${url}" target="_blank">🔗 Raw video</a>`;
        document.getElementById('replay').src = url;

        // fetch user data
        const u = await fetchJson(
          `https://osu.ppy.sh/api/get_user?`+
          `k=${OSU_API_KEY}&u=${encodeURIComponent(meta.username)}`
        );
        if(!u.length) throw 'User not found';
        actualRank   = parseInt(u[0].pp_rank,10);
        countryRank  = parseInt(u[0].pp_country_rank,10);
        playTimeHrs  = Math.round(parseInt(u[0].total_seconds_played,10)/3600);
        const best = await fetchJson(
          `https://osu.ppy.sh/api/get_user_best?`+
          `k=${OSU_API_KEY}&u=${encodeURIComponent(meta.username)}&limit=1`
        );
        topPlayPP = best.length ? Math.round(parseFloat(best[0].pp)) : null;

        // show guessing UI
        document.getElementById('guess-container').style.display = 'block';

      } catch(e){
        console.error(e);
        document.getElementById('info').textContent = 'Error, retrying…';
        setTimeout(loadRandom,3000);
      }
    }

    // ── GUESS HANDLER ─────────────────────────────────────────────────
    document.getElementById('guess-btn').onclick = ()=>{
      const val = parseInt(document.getElementById('guess-input').value.replace(/,/g,''),10);
      const resEl = document.getElementById('guess-result');
      const hintsEl = document.getElementById('hints');
      if(isNaN(val)) return;

      guessAttempts++;
      // always say wrong or right
      const diff = Math.abs(val-actualRank);
      const tol  = toleranceFor(actualRank);
      if(diff<=tol){
        resEl.textContent = `✅ Correct! Actual rank was ${actualRank.toLocaleString()}`;
        document.getElementById('reload').style.display = 'inline-block';
        document.getElementById('guess-container').style.display = 'none';
        return;
      } else {
        resEl.textContent = '❌ Wrong!';
      }

      // reveal next hint
      const allHints = [
        `Country Rank: #${countryRank.toLocaleString()}`,
        `Total Play Time: ${playTimeHrs.toLocaleString()} hr${playTimeHrs>1?'s':''}`,
        topPlayPP!=null 
          ? `Top Play PP: ${topPlayPP.toLocaleString()} pp`
          : `Top play data unavailable`
      ];
      hintsEl.innerHTML = '';
      for(let i=0;i<Math.min(guessAttempts, allHints.length); i++){
        const li = document.createElement('li');
        li.textContent = allHints[i];
        hintsEl.appendChild(li);
      }

      // auto-fail after last hint
      if(guessAttempts >= allHints.length){
        resEl.textContent = `💥 Out of hints! The rank was ${actualRank.toLocaleString()}`;
        document.getElementById('reload').style.display = 'inline-block';
        document.getElementById('guess-container').style.display = 'none';
      }
    };

    // ── NEXT REPLAY ─────────────────────────────────────────────────────
    document.getElementById('reload').onclick = loadRandom;

    // ── START ───────────────────────────────────────────────────────────
    loadRandom();
  </script>
</body>
</html>
